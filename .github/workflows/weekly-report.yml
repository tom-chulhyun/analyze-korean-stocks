name: Weekly Stock Report

on:
  schedule:
    # 매주 월요일 한국시간 오전 9시 (UTC 0시)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      mode:
        description: '분석 모드'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto          # 거래대금 상위 자동 선정
          - manual        # 종목코드 직접 입력
      stock_codes:
        description: '종목코드 (manual 모드, 쉼표 구분)'
        required: false
        default: ''
      top_n:
        description: '상위 N개 종목 (auto 모드)'
        required: false
        default: '10'
      period:
        description: '분석 기간 (일)'
        required: false
        default: '30'

env:
  DART_API_KEY: ${{ secrets.DART_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
  NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies (WeasyPrint)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf2.0-0 \
            libffi-dev \
            shared-mime-info

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Get top stocks and generate reports
        run: |
          MODE="${{ github.event.inputs.mode || 'auto' }}"
          PERIOD="${{ github.event.inputs.period || '30' }}"
          TOP_N="${{ github.event.inputs.top_n || '10' }}"
          MANUAL_CODES="${{ github.event.inputs.stock_codes || '' }}"

          echo "=========================================="
          echo "분석 모드: $MODE"
          echo "분석 기간: ${PERIOD}일"
          echo "=========================================="

          if [ "$MODE" = "manual" ] && [ -n "$MANUAL_CODES" ]; then
            # 수동 모드: 입력된 종목코드 사용
            CODES="$MANUAL_CODES"
            echo "수동 입력 종목: $CODES"
          else
            # 자동 모드: 거래대금 상위 종목 조회
            echo "거래대금 상위 ${TOP_N}개 종목 조회 중..."
            CODES=$(uv run python -c "
          from stock_analyzer.collectors.stock_price import StockPriceCollector
          collector = StockPriceCollector()
          stocks = collector.get_top_stocks_by_trading_value(top_n=${TOP_N})
          print(','.join([s['code'] for s in stocks]))
          ")
            echo "선정된 종목: $CODES"
          fi

          # 종목별 리포트 생성
          IFS=',' read -ra CODE_ARRAY <<< "$CODES"
          for CODE in "${CODE_ARRAY[@]}"; do
            CODE=$(echo "$CODE" | xargs)  # trim whitespace
            if [ -n "$CODE" ]; then
              echo ""
              echo "=========================================="
              echo "리포트 생성: $CODE"
              echo "=========================================="
              uv run stock-report "$CODE" --period "$PERIOD" || echo "⚠️ $CODE 리포트 생성 실패"
            fi
          done

      - name: Upload reports to GitHub
        run: |
          uv run python -c "
          from pathlib import Path
          from stock_analyzer.notifiers.github_uploader import GitHubUploader

          uploader = GitHubUploader(max_reports=10)
          pdf_files = list(Path('./output').glob('*.pdf'))

          if pdf_files:
              print(f'업로드할 파일: {len(pdf_files)}개')
              success, links = uploader.upload_reports(pdf_files)
              if success:
                  print('✅ 업로드 완료')
                  for link in links:
                      print(f'  - {link}')
              else:
                  print('❌ 업로드 실패')
          else:
              print('업로드할 파일 없음')
          "

      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-reports
          path: output/*.pdf
          retention-days: 30
