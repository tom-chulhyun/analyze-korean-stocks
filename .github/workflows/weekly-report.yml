name: Stock Report

on:
  schedule:
    # 2일마다 한국시간 오전 8시 (UTC 23시)
    - cron: '0 23 */2 * *'
  workflow_dispatch:
    inputs:
      top_n:
        description: '상위 N개 종목'
        required: false
        default: '10'
      market:
        description: '시장 (KOSPI/KOSDAQ/ALL)'
        required: false
        default: 'ALL'
      period:
        description: '분석 기간 (일)'
        required: false
        default: '30'

env:
  DART_API_KEY: ${{ secrets.DART_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
  NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies (WeasyPrint + Korean fonts)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf2.0-0 \
            libffi-dev \
            shared-mime-info \
            fonts-nanum \
            fonts-nanum-coding \
            fonts-noto-cjk
          # matplotlib 폰트 캐시 갱신
          fc-cache -fv

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Generate reports (auto-select top stocks)
        run: |
          TOP_N="${{ github.event.inputs.top_n || '10' }}"
          MARKET="${{ github.event.inputs.market || 'ALL' }}"
          PERIOD="${{ github.event.inputs.period || '30' }}"

          echo "=========================================="
          echo "거래대금 상위 ${TOP_N}개 종목 분석"
          echo "시장: ${MARKET}"
          echo "분석 기간: ${PERIOD}일"
          echo "=========================================="

          # 자동 종목 선정 + 리포트 생성 (2개 이상 시 자동 병합)
          uv run stock-report --top "$TOP_N" --market "$MARKET" --period "$PERIOD" || echo "⚠️ 일부 리포트 생성 실패"

      - name: Upload reports to GitHub
        run: |
          uv run python -c "
          from pathlib import Path
          from stock_analyzer.notifiers.github_uploader import GitHubUploader

          uploader = GitHubUploader(max_reports=20)
          pdf_files = list(Path('./output').glob('*.pdf'))

          if pdf_files:
              print(f'업로드할 파일: {len(pdf_files)}개')
              success, links = uploader.upload_reports(pdf_files)
              if success:
                  print('✅ 업로드 완료')
                  for link in links:
                      print(f'  - {link}')
              else:
                  print('❌ 업로드 실패')
          else:
              print('업로드할 파일 없음')
          "

      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-reports
          path: output/*.pdf
          retention-days: 30
